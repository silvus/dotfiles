#!/usr/bin/env bash

set -e -o pipefail

# Env variables not setted ?
HOME="/home/$(whoami)"

function resolve_fzf() {
	if [ -x "$HOME/.fzf/bin/fzf" ]; then
		echo "$HOME/.fzf/bin/fzf"
	elif [ -x "/run/current-system/sw/bin/fzf" ]; then
		echo "/run/current-system/sw/bin/fzf"
	else
		echo "fzf not found" 1>&2
		exit 1
	fi
}

function fzf-url () {
	local content="$(tmux capture-pane -J -p)"

	mapfile -t urls < <(echo "$content" | grep -oE '(https?|ftp|file):/?//[-A-Za-z0-9+&@#/%?=~_|!:,.;]*[-A-Za-z0-9+&@#/%=~_|]')
	mapfile -t wwws < <(echo "$content" | grep -oE '(http?s://)?www\.[a-zA-Z](-?[a-zA-Z0-9])+\.[a-zA-Z]{2,}(/\S+)*' | grep -vE '^https?://' | sed 's/^/http:\/\//')
	mapfile -t ips  < <(echo "$content" | grep -oE '[0-9]{1,3}(\.[0-9]{1,3}){3}(:[0-9]{1,5})?(/\S+)*' | sed 's/^/http:\/\//')
	mapfile -t gits < <(echo "$content" | grep -oE '(ssh://)?git@\S*' | sed 's/:/\//g' | sed 's/^\(ssh\/\/\/\)\{0,1\}git@/https:\/\//')

	local items
	items=$(printf '%s\n' "${urls[@]}" "${wwws[@]}" "${ips[@]}" "${gits[@]}" |
		grep -v '^$' |
		sort -u |
		nl -w3 -s '  '
	)

	[ -z "$items" ] && exit

	local fzf_path
	fzf_path="$(resolve_fzf)"

	local chosen="$(printf '%s\n' "$items" |
		"$fzf_path" --tmux -d 35% -m -0 --no-preview --no-border |
		awk '{print $2}'
	)"

	if [ -n "$chosen" ]; then
		"$HOME/.config/newsboat/browse" "$chosen"
	fi
}

fzf-url

exit 0
