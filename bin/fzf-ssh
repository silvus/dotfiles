#!/usr/bin/env bash

set -e -o pipefail

function print_usage() {
	echo "Usage: $0 [-m]" 1>&2
	echo
	echo "Read SSH hosts from ~/.ssh/config"
	echo "Pick one with FZF and ssh to it on a new Tmux window"
	echo "if flag -m is used, used mosh instead of ssh"
	exit 0
}

function resolve_fzf() {
	if [ -x "$HOME/.fzf/bin/fzf" ]; then
		echo "$HOME/.fzf/bin/fzf"
	elif [ -x "/run/current-system/sw/bin/fzf" ]; then
		echo "/run/current-system/sw/bin/fzf"
	else
		echo "fzf not found in ~/.fzf/bin or /run/current-system/sw/bin" 1>&2
		exit 1
	fi
}

function fzf-ssh () {
	local fzf_path
	fzf_path="$(resolve_fzf)"

	local selected_host

	set +e
	selected_host=$(
		grep "^Host " "$HOME/.ssh/config" \
		| grep -v '\*' \
		| awk '{print $2}' \
		| "$fzf_path" --tmux --prompt="$SSH_LABEL Remote > "
	)
	local fzf_status=$?
	set -e

	# ESC pressed or no selection: exit cleanly
	if [ "$fzf_status" -ne 0 ] || [ -z "$selected_host" ]; then
		return 0
	fi

	if [ -n "$TMUX" ]; then
		tmux new-window -n "$selected_host" "$SSH_PATH $selected_host $SSH_COMMAND"
	else
		$SSH_PATH "$selected_host" $SSH_COMMAND
	fi
}

# Ensure HOME is set predictably
HOME="/home/$(whoami)"

# Defaults
SSH_PATH="$(command -v ssh)"
SSH_LABEL="SSH"
SSH_COMMAND=""

# Flags
while getopts "hm" opt; do
	case "$opt" in
		h)
			print_usage
			;;
		m)
			SSH_PATH="$(command -v mosh)"
			SSH_LABEL="Mosh"
			SSH_COMMAND="$HOME/.dotfiles/bin/tmuxdev"
			;;
	esac
done

fzf-ssh
